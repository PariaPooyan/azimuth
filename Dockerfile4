FROM satijalab/azimuth:0.4.6

RUN apt-get update
RUN apt-get install -y libv8-dev
RUN apt-get install -y libbz2-dev
RUN apt-get install -y liblzma-dev

COPY Rprofile.site /usr/local/lib/R/etc/Rprofile.site
RUN R --no-echo -e "system.file(package = 'Bsgenome.Hsapiens.UCSC.hg38')"
RUN R --no-echo -e "system.file(package = 'Seurat')"

FROM bioconductor/bioconductor_docker:RELEASE_3_14
COPY --from=0 /usr/local/lib/R/site-library /usr/local/lib/R/site-library

## Install Bioconductor packages
COPY ./requirements-bioc.R .
RUN apt-get update \
 && apt-get install -y --no-install-recommends \
   libfftw3-dev \
   gcc && apt-get clean \
 && rm -rf /var/lib/apt/lists/*
RUN Rscript -e 'requireNamespace("BiocManager"); BiocManager::install(ask=F, update = F);' \
&& Rscript requirements-bioc.R
RUN R --no-echo -e "install.packages('sp', repos='http://cran.us.r-project.org')"
RUN R --no-echo -e "install.packages('Matrix', repos='http://R-Forge.R-project.org')"
RUN R --no-echo -e "remotes::install_github('mojaveazure/seurat-object',  'seurat5',  build = TRUE)"
RUN R --no-echo -e "remotes::install_github('satijalab/seurat', 'seurat5',  build = FALSE)"
RUN R --no-echo -e "remotes::install_github(c('immunogenomics/presto', 'mojaveazure/seurat-disk', 'satijalab/seurat-data'), dependencies = FALSE)"

RUN R --no-echo --no-restore --no-save -e "remotes::install_github('stuart-lab/signac', 'seurat5')"
RUN R --no-echo -e "remotes::install_version('shinyBS', '0.61', repo='https://cloud.r-project.org')"
RUN R --no-echo -e "remotes::install_version('shinydashboard', '0.7.2', repo='https://cloud.r-project.org')"
RUN R --no-echo -e "remotes::install_version('shinyjs', '2.1.0', repo='https://cloud.r-project.org')"
RUN R --no-echo -e "remotes::install_version('shiny', '1.7.1', repo='https://cloud.r-project.org')"


ARG AZIMUTH_VER=unknown
RUN echo "$AZIMUTH_VER"
COPY . /root/azimuth
RUN R --no-echo -e "system.file(package = 'Bsgenome.Hsapiens.UCSC.hg38')"
RUN R --no-echo -e "system.file(package = 'Seurat')"
RUN R --no-echo -e "system.file(package ='shiny')"
RUN R --no-echo -e ".libPaths()"
RUN R --no-echo -e "install.packages('/root/azimuth', repos = NULL,  type = 'source')"

CMD ["R", "-e", "Azimuth::AzimuthApp(reference='/reference-data')"]
